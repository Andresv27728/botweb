<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Bot Dashboard</title>
    <style>
        body { font-family: sans-serif; background-color: #f0f2f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px 0; }
        .container { background-color: white; padding: 40px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); text-align: center; max-width: 500px; }
        #qr-container { display: block; }
        #dashboard { display: none; }
        h1, h2 { color: #128C7E; }
        canvas { border: 1px solid #ddd; }
        .info { margin-top: 20px; text-align: left; }
        .info p { margin: 5px 0; }
        #settings-form { margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; }
        #bot-settings-form label { display: block; text-align: left; margin: 10px 0 5px; }
        #bot-settings-form input { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        #bot-settings-form button { background-color: #25D366; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; margin-top: 20px; }
        #update-button { background-color: #f39c12; }
        #save-status { margin-top: 10px; font-weight: bold; }
        #timer-container { margin-top: 15px; font-size: 1.1em; color: #555; }
    </style>
</head>
<body>
    <div class="container">
        <div id="qr-container">
            <h1>Escanea el código QR para conectar</h1>
            <canvas id="qr"></canvas>
            <div id="timer-container">
                <p>El QR se actualizará en <span id="timer">30</span>s</p>
            </div>
            <p>Por favor, escanea el código QR con tu teléfono para vincular el bot.</p>
        </div>
        <div id="dashboard">
            <h1>Bot Conectado</h1>
            <div class="info">
                <p><strong>Nombre del Bot:</strong> <span id="bot-name"></span></p>
                <p><strong>Latencia:</strong> <span id="latency">N/A</span></p>
                <p><strong>Estado:</strong> <span id="status" style="color: green;">Conectado</span></p>
            </div>
            <div id="stats-container" class="info">
                <h2>Rendimiento del Servidor</h2>
                <p><strong>CPU:</strong> <span id="cpu-usage">Cargando...</span></p>
                <p><strong>Memoria:</strong> <span id="memory-usage">Cargando...</span></p>
                <p><strong>Tiempo Activo:</strong> <span id="uptime">Cargando...</span></p>
            </div>
            <div id="settings-form">
                <h2>Configuración</h2>
                <form id="bot-settings-form">
                    <label for="botNameInput">Nombre del Bot:</label>
                    <input type="text" id="botNameInput" name="botName">
                    <label for="ownerNameInput">Nombre del Propietario:</label>
                    <input type="text" id="ownerNameInput" name="ownerName">
                    <label for="ownerLidJidInput">Owner JID (LID - para grupos):</label>
                    <input type="text" id="ownerLidJidInput" name="ownerLidJid" placeholder="Usa /jid en un grupo">
                    <label for="ownerPhoneJidInput">Owner JID (Teléfono - para chat privado):</label>
                    <input type="text" id="ownerPhoneJidInput" name="ownerPhoneJid" placeholder="Usa /jid en chat privado con el bot">
                    <button type="submit">Guardar Cambios</button>
                </form>
                <p id="save-status"></p>
                <div id="update-section" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
                    <h2>Actualización del Bot</h2>
                    <p>Actualiza el bot a la última versión desde GitHub. Esto reiniciará el proceso.</p>
                    <button type="button" id="update-button" class="button">Actualizar Ahora</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
    <script>
        const socket = io();
        const qrContainer = document.getElementById('qr-container');
        const dashboard = document.getElementById('dashboard');
        const botNameEl = document.getElementById('bot-name');
        const latencyEl = document.getElementById('latency');
        const timerEl = document.getElementById('timer');
        const timerContainer = document.getElementById('timer-container');

        const settingsForm = document.getElementById('bot-settings-form');
        const botNameInput = document.getElementById('botNameInput');
        const ownerNameInput = document.getElementById('ownerNameInput');
        const ownerLidJidInput = document.getElementById('ownerLidJidInput');
        const ownerPhoneJidInput = document.getElementById('ownerPhoneJidInput');
        const saveStatus = document.getElementById('save-status');
        const updateButton = document.getElementById('update-button');

        let countdownInterval;

        function startTimer(duration) {
            let timer = duration;
            timerEl.textContent = timer;
            timerContainer.style.display = 'block';

            clearInterval(countdownInterval); // Limpiar cualquier temporizador anterior
            countdownInterval = setInterval(() => {
                timer--;
                timerEl.textContent = timer;
                if (timer <= 0) {
                    clearInterval(countdownInterval);
                    timerContainer.innerHTML = '<p>Esperando nuevo QR...</p>';
                }
            }, 1000);
        }

        async function fetchSettings() {
            try {
                const response = await fetch('/api/settings');
                if (!response.ok) throw new Error('No se pudo obtener la configuración');
                const settings = await response.json();
                botNameInput.value = settings.botName;
                ownerNameInput.value = settings.ownerName;
                ownerLidJidInput.value = settings.ownerLidJid || '';
                ownerPhoneJidInput.value = settings.ownerPhoneJid || '';
                botNameEl.textContent = settings.botName;
            } catch (error) {
                console.error('Error fetching settings:', error);
                saveStatus.textContent = 'Error al cargar la configuración.';
            }
        }

        settingsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            saveStatus.textContent = 'Guardando...';
            const newSettings = {
                botName: botNameInput.value,
                ownerName: ownerNameInput.value,
                ownerLidJid: ownerLidJidInput.value,
                ownerPhoneJid: ownerPhoneJidInput.value
            };
            try {
                const response = await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newSettings)
                });
                if (!response.ok) throw new Error('Respuesta no fue OK');
                const result = await response.json();
                saveStatus.textContent = result.message;
                setTimeout(() => saveStatus.textContent = '', 3000);
            } catch (error) {
                saveStatus.textContent = 'Error al guardar.';
                console.error('Error saving settings:', error);
            }
        });

        socket.on('qr', (qr) => {
            new QRious({
                element: document.getElementById('qr'),
                value: qr,
                size: 250,
            });
            qrContainer.style.display = 'block';
            dashboard.style.display = 'none';
            timerContainer.innerHTML = '<p>El QR se actualizará en <span id="timer">30</span>s</p>';
            // Re-asignar timerEl porque el innerHTML lo borró
            const newTimerEl = document.getElementById('timer');
            timerEl = newTimerEl ? newTimerEl : document.createElement('span'); // Fallback
            startTimer(30);
        });

        socket.on('connected', (data) => {
            qrContainer.style.display = 'none';
            dashboard.style.display = 'block';
            clearInterval(countdownInterval); // Detener el temporizador al conectar
            botNameEl.textContent = data.botName;
            fetchSettings();
        });

        socket.on('bot-info', (data) => {
            latencyEl.textContent = `${data.latency}`;
            botNameEl.textContent = data.botName;
        });

        socket.on('settings-updated', (newSettings) => {
            botNameInput.value = newSettings.botName;
            ownerNameInput.value = newSettings.ownerName;
            ownerLidJidInput.value = newSettings.ownerLidJid || '';
            ownerPhoneJidInput.value = newSettings.ownerPhoneJid || '';
            botNameEl.textContent = newSettings.botName;
            console.log('Configuración del frontend actualizada por evento de socket.');
        });

        socket.on('disconnect', () => {
            qrContainer.style.display = 'block';
            dashboard.style.display = 'none';
        });

        // --- Server Stats Handler ---
        const cpuUsageEl = document.getElementById('cpu-usage');
        const memoryUsageEl = document.getElementById('memory-usage');
        const uptimeEl = document.getElementById('uptime');

        socket.on('server-stats', (data) => {
            if(cpuUsageEl) cpuUsageEl.textContent = data.cpu;
            if(memoryUsageEl) memoryUsageEl.textContent = data.memory;
            if(uptimeEl) uptimeEl.textContent = data.uptime;
        });

        // --- Update Button Handler ---
        updateButton.addEventListener('click', async () => {
            const confirmed = confirm('¿Estás seguro de que quieres actualizar el bot? Esto reiniciará el proceso.');
            if (confirmed) {
                saveStatus.textContent = 'Iniciando actualización...';
                try {
                    const response = await fetch('/api/update', { method: 'POST' });
                    const result = await response.json();
                    saveStatus.textContent = result.message;
                    // El bot se reiniciará, no es necesario hacer nada más aquí.
                } catch (error) {
                    saveStatus.textContent = 'Error al iniciar la actualización.';
                    console.error('Error on update:', error);
                }
            }
        });
    </script>
</body>
</html>
